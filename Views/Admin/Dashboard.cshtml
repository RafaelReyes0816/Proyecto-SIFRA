@{
    ViewData["Title"] = "Dashboard - Administrador";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

@{
    var stats = ViewBag.Estadisticas as dynamic;
    var productosBajoStock = ViewBag.ProductosBajoStock as List<Tienda_Repuestos_Demo.Models.Producto>;
    var ultimasVentas = ViewBag.UltimasVentas as List<Tienda_Repuestos_Demo.Models.Venta>;
    var ultimosUsuarios = ViewBag.UltimosUsuarios as List<Tienda_Repuestos_Demo.Models.Usuario>;
    var ultimosClientes = ViewBag.UltimosClientes as List<Tienda_Repuestos_Demo.Models.Cliente>;
    var distribucionRoles = ViewBag.DistribucionRoles as System.Collections.IEnumerable;
}

<div class="container-fluid">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <div>
            <h2 class="mb-1" style="color: #ffffff; font-weight: 700;">üë®‚Äçüíº Dashboard - Administrador</h2>
            <p class="text-muted mb-0">Bienvenido, @Context.Session.GetString("UsuarioNombre")</p>
        </div>
    </div>

    @if (productosBajoStock != null && productosBajoStock.Any())
    {
        <div class="alert alert-warning alert-dismissible fade show" role="alert" style="border-left: 4px solid var(--warning-color);">
            <h5 class="alert-heading mb-2">
                ‚ö†Ô∏è <strong>Alerta de Stock Bajo</strong>
            </h5>
            <p class="mb-2">
                Tienes <strong>@productosBajoStock.Count</strong> producto(s) con stock bajo o agotado que requieren atenci√≥n inmediata.
            </p>
            <hr>
            <p class="mb-0">
                <a href="#productos-bajo-stock" class="alert-link">Ver lista de productos con stock bajo ‚Üì</a>
            </p>
            <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
        </div>
    }

    <div class="row mb-4">
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-primary">
                <h5>üë• Total Usuarios</h5>
                <h2>@stats?.TotalUsuarios</h2>
                <small style="opacity: 0.8;">@(stats?.UsuariosActivos ?? 0) activos</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-success">
                <h5>üë§ Total Clientes</h5>
                <h2>@stats?.TotalClientes</h2>
                <small style="opacity: 0.8;">@(stats?.ClientesVerificados ?? 0) verificados</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-info">
                <h5>üì¶ Total Productos</h5>
                <h2>@stats?.TotalProductos</h2>
                <small style="opacity: 0.8;">En @(stats?.TotalCategorias ?? 0) categor√≠as</small>
            </div>
        </div>
        <div class="col-md-3 mb-3">
            <div class="stat-card bg-warning">
                <h5>üí∞ Total Ventas</h5>
                <h2>@stats?.TotalVentas</h2>
                <small style="opacity: 0.8;">@(stats?.VentasPendientes ?? 0) pendientes</small>
            </div>
        </div>
    </div>

    <div class="row mb-4">
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: var(--text-medium);">üìä Ventas Hoy</h5>
                    <h3 class="text-primary mb-0" style="font-weight: 700;">@stats?.VentasHoy</h3>
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card @(stats?.ProductosBajoStock > 0 ? "border-warning" : "")" style="@(stats?.ProductosBajoStock > 0 ? "border-width: 3px;" : "")">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: var(--text-medium);">‚ö†Ô∏è Productos Bajo Stock</h5>
                    <h3 class="@(stats?.ProductosBajoStock > 0 ? "text-danger" : "text-success") mb-0" style="font-weight: 700;">
                        @stats?.ProductosBajoStock
                    </h3>
                    @if (stats?.ProductosBajoStock > 0)
                    {
                        <small class="text-danger">Requiere atenci√≥n</small>
                    }
                    else
                    {
                        <small class="text-success">Todo en orden</small>
                    }
                </div>
            </div>
        </div>
        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-body text-center">
                    <h5 class="card-title" style="color: var(--text-medium);">üíµ Total Ingresos</h5>
                    <h3 class="text-success mb-0" style="font-weight: 700;">$@(stats?.TotalIngresos?.ToString("N2") ?? "0.00")</h3>
                </div>
            </div>
        </div>
    </div>

    @if (productosBajoStock != null && productosBajoStock.Any())
    {
        <div class="row mb-4" id="productos-bajo-stock">
            <div class="col-md-12">
                <div class="card border-warning">
                    <div class="card-header bg-warning text-dark">
                        <h5 class="mb-0">‚ö†Ô∏è Productos con Stock Bajo (@productosBajoStock.Count)</h5>
                    </div>
                    <div class="card-body">
                        <div class="table-responsive">
                            <table class="table table-hover">
                                <thead>
                                    <tr>
                                        <th>C√≥digo</th>
                                        <th>Producto</th>
                                        <th>Categor√≠a</th>
                                        <th>Stock Actual</th>
                                        <th>Stock M√≠nimo</th>
                                        <th>Estado</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var producto in productosBajoStock)
                                    {
                                        var porcentajeStock = producto.StockMinimo > 0 ? (producto.Stock * 100.0 / producto.StockMinimo) : 0;
                                        var nivelAlerta = producto.Stock <= 0 ? "Agotado" : 
                                                         producto.Stock <= (producto.StockMinimo * 0.5) ? "Cr√≠tico" : "Bajo";
                                        var badgeColor = producto.Stock <= 0 ? "danger" : 
                                                        producto.Stock <= (producto.StockMinimo * 0.5) ? "danger" : "warning";
                                        
                                        <tr class="@(producto.Stock <= 0 ? "table-danger" : "table-warning")">
                                            <td><strong>@producto.Codigo</strong></td>
                                            <td>@producto.Nombre</td>
                                            <td>@producto.Categoria?.Nombre</td>
                                            <td>
                                                <span class="badge bg-@badgeColor" style="font-size: 1rem;">
                                                    @producto.Stock unidades
                                                </span>
                                            </td>
                                            <td>@producto.StockMinimo unidades</td>
                                            <td>
                                                <span class="badge bg-@badgeColor">‚ö†Ô∏è @nivelAlerta</span>
                                            </td>
                                            <td>
                                                <a href="@Url.Action("Edit", "Productos", new { id = producto.IdProducto })" class="btn btn-sm btn-warning">
                                                    ‚úèÔ∏è Actualizar Stock
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-3">
                            <a href="@Url.Action("Index", "Productos")" class="btn btn-primary">
                                üì¶ Ver Todos los Productos
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    }

    <!-- √öltimas Ventas y Actividad Reciente -->
    <div class="row mb-4">
        <div class="col-md-8 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üí∞ √öltimas Ventas</h5>
                </div>
                <div class="card-body">
                    @if (ultimasVentas != null && ultimasVentas.Any())
                    {
                        <div class="table-responsive">
                            <table class="table table-hover table-sm">
                                <thead>
                                    <tr>
                                        <th>ID</th>
                                        <th>Fecha</th>
                                        <th>Cliente</th>
                                        <th>Vendedor</th>
                                        <th>Estado</th>
                                        <th>Total</th>
                                        <th>Acci√≥n</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    @foreach (var venta in ultimasVentas)
                                    {
                                        <tr>
                                            <td><strong>#@venta.IdVenta</strong></td>
                                            <td>@venta.Fecha.ToString("dd/MM/yyyy HH:mm")</td>
                                            <td>@venta.Cliente?.Nombre</td>
                                            <td>@venta.Vendedor?.Nombre</td>
                                            <td>
                                                <span class="badge bg-@(venta.Estado == "confirmada" ? "success" : venta.Estado == "pendiente" ? "warning" : "danger")">
                                                    @venta.Estado
                                                </span>
                                            </td>
                                            <td><strong>$@venta.Total.ToString("N2")</strong></td>
                                            <td>
                                                <a href="@Url.Action("Details", "Ventas", new { id = venta.IdVenta })" class="btn btn-sm btn-info">
                                                    üëÅÔ∏è Ver
                                                </a>
                                            </td>
                                        </tr>
                                    }
                                </tbody>
                            </table>
                        </div>
                        <div class="mt-2">
                            <a href="@Url.Action("Index", "Ventas")" class="btn btn-sm btn-outline-primary">
                                Ver todas las ventas ‚Üí
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            No hay ventas registradas a√∫n.
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-4 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üë• Distribuci√≥n de Roles</h5>
                </div>
                <div class="card-body">
                    @if (distribucionRoles != null)
                    {
                        @foreach (dynamic rol in distribucionRoles)
                        {
                            var rolNombre = rol?.Rol;
                            var colorRol = rolNombre == "admin" ? "danger" : 
                                          rolNombre == "vendedor" ? "warning" : "info";
                            var iconoRol = rolNombre == "admin" ? "üë®‚Äçüíº" : 
                                          rolNombre == "vendedor" ? "üõí" : "üë§";
                            
                            <div class="d-flex justify-content-between align-items-center mb-2 p-2" style="background: rgba(0,0,0,0.05); border-radius: 5px;">
                                <span>
                                    @iconoRol <strong style="text-transform: capitalize;">@rolNombre</strong>
                                </span>
                                <span class="badge bg-@colorRol">@(rol?.Cantidad ?? 0)</span>
                            </div>
                        }
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            No hay informaci√≥n de roles disponible.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- √öltimos Usuarios y Clientes -->
    <div class="row mb-4">
        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üë§ √öltimos Usuarios Registrados</h5>
                </div>
                <div class="card-body">
                    @if (ultimosUsuarios != null && ultimosUsuarios.Any())
                    {
                        @foreach (var usuario in ultimosUsuarios)
                        {
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                                <div>
                                    <h6 class="mb-1">@usuario.Nombre</h6>
                                    <p class="mb-1 text-muted small">üìß @usuario.Correo</p>
                                    <div>
                                        <span class="badge bg-@(usuario.Rol == "admin" ? "danger" : usuario.Rol == "vendedor" ? "warning" : "info")">
                                            @usuario.Rol
                                        </span>
                                        @if (usuario.Activo)
                                        {
                                            <span class="badge bg-success">‚úÖ Activo</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-secondary">‚ùå Inactivo</span>
                                        }
                                    </div>
                                </div>
                                <small class="text-muted">@usuario.FechaRegistro.ToString("dd/MM/yyyy")</small>
                            </div>
                        }
                        <div class="mt-2">
                            <a href="@Url.Action("Index", "Usuarios")" class="btn btn-sm btn-outline-warning">
                                Ver todos los usuarios ‚Üí
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            No hay usuarios registrados.
                        </div>
                    }
                </div>
            </div>
        </div>

        <div class="col-md-6 mb-3">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">üë• √öltimos Clientes Registrados</h5>
                </div>
                <div class="card-body">
                    @if (ultimosClientes != null && ultimosClientes.Any())
                    {
                        @foreach (var cliente in ultimosClientes)
                        {
                            <div class="d-flex justify-content-between align-items-start mb-3 pb-3 border-bottom">
                                <div>
                                    <h6 class="mb-1">@cliente.Nombre</h6>
                                    <p class="mb-1 text-muted small">üìß @cliente.Correo</p>
                                    <div>
                                        @if (cliente.Verificado)
                                        {
                                            <span class="badge bg-success">‚úÖ Verificado</span>
                                        }
                                        else
                                        {
                                            <span class="badge bg-warning">‚è≥ Pendiente</span>
                                        }
                                        @if (!string.IsNullOrEmpty(cliente.FotoCI))
                                        {
                                            <span class="badge bg-info">üìÑ CI Subido</span>
                                        }
                                    </div>
                                </div>
                                <small class="text-muted">@cliente.FechaRegistro.ToString("dd/MM/yyyy")</small>
                            </div>
                        }
                        <div class="mt-2">
                            <a href="@Url.Action("Index", "Clientes")" class="btn btn-sm btn-outline-success">
                                Ver todos los clientes ‚Üí
                            </a>
                        </div>
                    }
                    else
                    {
                        <div class="alert alert-info mb-0">
                            No hay clientes registrados.
                        </div>
                    }
                </div>
            </div>
        </div>
    </div>

</div>
